# SARIMA/differencing.py
"""
Дифференцирование.
Вход:
    boxcox_series — преобразованный ряд Бокса–Кокса
    icase — схема дифференцирования (0..4)

Выход:
    diff_series — результат дифференцирования
    intermediate_series — используется только для Icase=2 и Icase=4
    nd — количество нулей в начале ряда
"""

import numpy as np


def differencing(boxcox_series: np.ndarray, icase: int):

    x = np.asarray(boxcox_series, dtype=float)
    n = len(x)

    # ----------------------------------------------------
    # Icase = 0 — дифференцирование отсутствует
    # ----------------------------------------------------
    if icase == 0:
        diff_series = x.copy()
        nd = 0
        return diff_series, None, nd

    # ----------------------------------------------------
    # Icase = 1 — обычное дифференцирование d=1
    # ----------------------------------------------------
    if icase == 1:
        diff = np.zeros(n)
        diff[1:] = x[1:] - x[:-1]
        nd = 1
        return diff, None, nd

    # ----------------------------------------------------
    # Icase = 2 — двойное обычное дифференцирование d=2
    # ----------------------------------------------------
    if icase == 2:
        x4 = np.zeros(n)
        x4[1:] = x[1:] - x[:-1]  # первое дифференцирование

        x5 = np.zeros(n)
        x5[2:] = x4[2:] - x4[1:-1]  # второе дифференцирование

        nd = 2
        return x5, x4, nd

    # ----------------------------------------------------
    # Icase = 3 — сезонное дифференцирование D=1 (лаг 12)
    # ----------------------------------------------------
    if icase == 3:
        diff = np.zeros(n)
        diff[12:] = x[12:] - x[:-12]
        nd = 12
        return diff, None, nd

    # ----------------------------------------------------
    # Icase = 4 — сезонное + обычное (D=1 затем d=1)
    # ----------------------------------------------------
    if icase == 4:
        # сезонное
        x4 = np.zeros(n)
        x4[12:] = x[12:] - x[:-12]

        # обычное
        x5 = np.zeros(n)
        x5[13:] = x4[13:] - x4[12:-1]

        nd = 13
        return x5, x4, nd

    # ----------------------------------------------------
    # Неверное значение icase
    # ----------------------------------------------------
    raise ValueError("icase должен быть в диапазоне 0..4")